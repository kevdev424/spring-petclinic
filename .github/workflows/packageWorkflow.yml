name: Package Pet Clinic

on: 
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build Pet Clinic App
      run: |
        cd src/
        mvn clean package
    - name: Test Pet Clinic App
      run: |
        cd src/
        mvn test
    - name: Package Pet Clinic App
      run: |
        cd src/
        mvn package
 
  validate:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Validate Pull Request
      run: |
        cd src/
        mvn validate
 
  deploy:
    runs-on: ubuntu-latest
    needs: [build, validate]
    steps:
    - name: Push to GitHub Packages
      run: |
        cd src/
        mvn deploy
    - name: Create Release
      run: |
        git tag v1.0.0
        git push --tag
        curl -X POST https://api.github.com/repos/${{ github.repository }}/releases \
        -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
        -d @- << EOF
        {
          "tag_name": "v1.0.0",
          "name": "Pet Clinic Release",
          "body": "This is the first release of the Pet Clinic application",
          "draft": false,
          "prerelease": false
        }
        EOF
