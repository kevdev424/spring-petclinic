<?xml version="1.0" encoding="UTF-8"?>
<configuration>
	<include resource="org/springframework/boot/logging/logback/base.xml"/>

    <!-- Default logback configuration -->
    <property name="LOG_FILE" value="${LOG_FILE:-${LOG_PATH:-${LOG_TEMP:-${java.io.tmpdir:-/tmp}}}/spring.log}"/>
    <include resource="org/springframework/boot/logging/logback/console-appender.xml"/>
    <include resource="org/springframework/boot/logging/logback/file-appender.xml"/>

	<appender name="OTEL" class="io.opentelemetry.instrumentation.logback.v1_0.OpenTelemetryAppender">
		<appender-ref ref="CONSOLE"/>
		<appender-ref ref="FILE"/>
	</appender>

	<appender name="JSON_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
		<encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
			<providers>
				<timestamp>
					<timeZone>UTC</timeZone>
				</timestamp>
				<pattern>
					<pattern>
						{
						"level": "%level",
						"logger": "%logger",
						"message": "%message",
						"service": "petclinic",
						"span_id": "%X{spanId}",
						"trace_id": "%X{traceId}",
						"timestamp": "%d{yyyy-MM-dd'T'HH:mm:ss.SSSZ}",
						"thread": "%thread"
						}
					</pattern>
				</pattern>
			</providers>
		</encoder>
	</appender>

	<appender name="JSON_FILE" class="ch.qos.logback.core.FileAppender">
		<file>./log/spring-petclinic.log</file>
		<encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
			<providers>
				<timestamp>
					<timeZone>UTC</timeZone>
				</timestamp>
				<pattern>
					<pattern>
						{
						"level": "%level",
						"logger": "%logger",
						"message": "%message",
						"service": "petclinic",
						"span_id": "%X{spanId}",
						"trace_id": "%X{traceId}",
						"timestamp": "%d{yyyy-MM-dd'T'HH:mm:ss.SSSZ}",
						"thread": "%thread"
						}
					</pattern>
				</pattern>
			</providers>
		</encoder>
	</appender>

	<root level="INFO">
		<appender-ref ref="OTEL"/>
	</root>
</configuration>
